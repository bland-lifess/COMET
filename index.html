<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COMET ðŸ’«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --rarity-common: #94a3b8;
            --rarity-rare: #3b82f6;
            --rarity-epic: #a855f7;
            --rarity-legendary: #eab308;
            --rarity-mythic: #ef4444;
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background-color: #0f172a;
            overflow: hidden;
            touch-action: manipulation;
            user-select: none;
        }

        .bg-grid {
            background-size: 50px 50px;
            background-image: 
                linear-gradient(to right, rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            animation: gridMove 60s linear infinite;
        }

        @keyframes gridMove { 0% { background-position: 0 0; } 100% { background-position: 50px 50px; } }

        /* Rarity Styles */
        .border-common { border-color: var(--rarity-common); }
        .text-common { color: var(--rarity-common); }
        .bg-common { background-color: var(--rarity-common); }
        
        .border-rare { border-color: var(--rarity-rare); box-shadow: 0 0 15px rgba(59, 130, 246, 0.3); }
        .text-rare { color: var(--rarity-rare); }
        .bg-rare { background-color: var(--rarity-rare); }

        .border-epic { border-color: var(--rarity-epic); box-shadow: 0 0 25px rgba(168, 85, 247, 0.4); }
        .text-epic { color: var(--rarity-epic); }
        .bg-epic { background-color: var(--rarity-epic); }

        .border-legendary { border-color: var(--rarity-legendary); box-shadow: 0 0 40px rgba(234, 179, 8, 0.5); }
        .text-legendary { color: var(--rarity-legendary); }
        .bg-legendary { background-color: var(--rarity-legendary); }

        .border-mythic { 
            border-color: var(--rarity-mythic); 
            box-shadow: 0 0 60px rgba(239, 68, 68, 0.6), inset 0 0 20px rgba(239, 68, 68, 0.4);
            animation: pulseMythic 2s infinite;
        }
        .text-mythic { color: var(--rarity-mythic); }
        .bg-mythic { background-color: var(--rarity-mythic); }

        @keyframes pulseMythic { 0%, 100% { filter: brightness(1); } 50% { filter: brightness(1.3); } }

        .animate-float { animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }

        .shake-1 { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        .shake-2 { animation: shakeHard 0.4s cubic-bezier(.36,.07,.19,.97) both; filter: brightness(1.2) sepia(1) hue-rotate(-50deg) saturate(3); }

        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        @keyframes shakeHard { 10%, 90% { transform: translate3d(-5px, 0, 0) rotate(-2deg); } 20%, 80% { transform: translate3d(5px, 0, 0) rotate(2deg); } 30%, 50%, 70% { transform: translate3d(-10px, 0, 0) rotate(-5deg); } 40%, 60% { transform: translate3d(10px, 0, 0) rotate(5deg); } }

        .item-reveal-anim { animation: popReveal 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        @keyframes popReveal { 0% { transform: scale(0) rotate(-45deg); opacity: 0; } 100% { transform: scale(1) rotate(0deg); opacity: 1; } }

        .sunburst {
            position: absolute; top: 50%; left: 50%; width: 200vmax; height: 200vmax;
            background: repeating-conic-gradient(from 0deg, rgba(255,255,255,0.03) 0deg 10deg, transparent 10deg 20deg);
            transform: translate(-50%, -50%); animation: spin 40s linear infinite; pointer-events: none; z-index: -1;
        }
        @keyframes spin { 100% { transform: translate(-50%, -50%) rotate(360deg); } }

        .shop-drawer { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .drawer-closed { transform: translateX(-100%); }
        .drawer-open { transform: translateX(0); }

        .music-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 2px solid rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        .music-btn:hover { transform: scale(1.1); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6); }
        .music-btn.playing { animation: musicPulse 2s infinite; }
        @keyframes musicPulse { 0%, 100% { box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); } 50% { box-shadow: 0 4px 25px rgba(102, 126, 234, 0.8); } }

        .code-success {
            animation: codeSuccess 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes codeSuccess {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* VFX Particles */
        .particle {
            position: absolute;
            pointer-events: none;
            z-index: 9999;
        }

        .click-particle {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: particleBurst 0.8s ease-out forwards;
        }

        @keyframes particleBurst {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
        }

        .tap-ring {
            position: absolute;
            border: 3px solid rgba(59, 130, 246, 0.8);
            border-radius: 50%;
            animation: ringExpand 0.6s ease-out forwards;
            pointer-events: none;
        }

        @keyframes ringExpand {
            0% { width: 40px; height: 40px; opacity: 1; transform: translate(-50%, -50%); }
            100% { width: 150px; height: 150px; opacity: 0; transform: translate(-50%, -50%); }
        }

        .coin-burst {
            position: absolute;
            font-size: 24px;
            animation: coinFloat 1s ease-out forwards;
            pointer-events: none;
            z-index: 9999;
        }

        @keyframes coinFloat {
            0% { transform: translateY(0) scale(0.5) rotate(0deg); opacity: 1; }
            50% { transform: translateY(-50px) scale(1.2) rotate(180deg); opacity: 1; }
            100% { transform: translateY(-100px) scale(0.5) rotate(360deg); opacity: 0; }
        }

        .sparkle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
            animation: sparkleFloat 1.5s ease-out forwards;
            pointer-events: none;
        }

        @keyframes sparkleFloat {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--sx), var(--sy)) scale(0); opacity: 0; }
        }

        .screen-flash {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
            pointer-events: none;
            z-index: 9998;
            animation: flashFade 0.5s ease-out forwards;
        }

        @keyframes flashFade {
            0% { opacity: 1; }
            100% { opacity: 0; }
        }

        .text-popup {
            position: absolute;
            font-weight: bold;
            font-size: 32px;
            color: white;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.8), 0 0 20px currentColor;
            animation: textPopup 1s ease-out forwards;
            pointer-events: none;
            z-index: 9999;
        }

        @keyframes textPopup {
            0% { transform: translateY(0) scale(0.5); opacity: 0; }
            20% { transform: translateY(-20px) scale(1.2); opacity: 1; }
            100% { transform: translateY(-80px) scale(1); opacity: 0; }
        }

        .shake-intense {
            animation: shakeIntense 0.3s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes shakeIntense {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            10% { transform: translate(-10px, -5px) rotate(-5deg); }
            20% { transform: translate(10px, 5px) rotate(5deg); }
            30% { transform: translate(-10px, 5px) rotate(-5deg); }
            40% { transform: translate(10px, -5px) rotate(5deg); }
            50% { transform: translate(-10px, -5px) rotate(-5deg); }
            60% { transform: translate(10px, 5px) rotate(5deg); }
            70% { transform: translate(-10px, 5px) rotate(-5deg); }
            80% { transform: translate(10px, -5px) rotate(5deg); }
            90% { transform: translate(-5px, -2px) rotate(-2deg); }
        }
    </style>
</head>
<body class="h-screen w-screen text-white relative overflow-hidden flex flex-col">

    <div class="absolute inset-0 bg-grid z-0 opacity-30 pointer-events-none"></div>

    <header class="relative z-30 flex justify-between items-center p-4 bg-slate-900/90 backdrop-blur border-b border-slate-700 h-20">
        <div class="flex items-center gap-4">
            <button id="shop-toggle" class="bg-cyan-600 hover:bg-cyan-500 text-white p-3 rounded-xl shadow-lg shadow-cyan-900/50 transition-all active:scale-95 group">
                <i class="fa-solid fa-store text-xl group-hover:rotate-12 transition-transform"></i>
            </button>
            <div class="flex flex-col">
                <span class="text-xs text-slate-400 font-bold tracking-widest uppercase">Current Box</span>
                <span id="current-box-name" class="font-['Black_Ops_One'] text-xl text-cyan-400 tracking-wide">Rusty Crate</span>
            </div>
        </div>

        <div class="flex items-center gap-4">
            <div class="bg-slate-800 px-4 py-2 rounded-xl border border-slate-700 flex items-center gap-3 shadow-inner">
                <i class="fa-solid fa-coins text-yellow-400 animate-pulse"></i>
                <span id="coin-display" class="font-mono text-2xl font-bold tracking-tighter">0</span>
            </div>
            <button id="codes-toggle" class="bg-purple-600 hover:bg-purple-500 text-white p-3 rounded-xl transition-all active:scale-95 relative shadow-lg">
                <i class="fa-solid fa-ticket text-xl"></i>
            </button>
            <button id="inventory-toggle" class="bg-slate-800 hover:bg-slate-700 border border-slate-600 text-slate-200 p-3 rounded-xl transition-all active:scale-95 relative">
                <i class="fa-solid fa-backpack text-xl"></i>
                <span id="inv-badge" class="absolute -top-1 -right-1 bg-red-500 text-[10px] w-5 h-5 rounded-full flex items-center justify-center font-bold hidden">0</span>
            </button>
        </div>
    </header>

    <aside id="shop-drawer" class="absolute top-20 left-0 bottom-0 w-80 bg-slate-900/95 backdrop-blur-xl border-r border-slate-700 z-40 shop-drawer drawer-closed flex flex-col shadow-2xl">
        <div class="p-6 border-b border-slate-800">
            <h2 class="text-2xl font-['Black_Ops_One'] uppercase text-white"><i class="fa-solid fa-cart-shopping mr-2 text-cyan-500"></i> Case Shop</h2>
            <p class="text-slate-400 text-sm mt-1">Upgrade your cases.</p>
        </div>
        <div id="shop-list" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
    </aside>

    <div id="shop-overlay" class="absolute inset-0 bg-black/50 z-30 hidden backdrop-blur-sm"></div>

    <main class="flex-grow relative z-10 flex flex-col items-center justify-center">
        <div id="sunburst" class="sunburst hidden"></div>

        <div id="box-stage" class="relative flex flex-col items-center">
            <div id="box-container" class="cursor-pointer transition-all duration-100 p-10 select-none">
                <div id="box-visual" class="text-9xl filter drop-shadow-[0_0_30px_rgba(255,255,255,0.1)] animate-float transition-all">ðŸ“¦</div>
            </div>
            <div id="instruction" class="mt-4 text-slate-400 font-bold tracking-[0.3em] uppercase animate-pulse">Tap to Open</div>
            <div id="box-cost-display" class="mt-2 px-3 py-1 bg-slate-800/50 rounded-full text-xs text-slate-300 font-mono hidden">Cost: <span class="text-yellow-400 font-bold">Free</span></div>
        </div>

        <div id="reveal-stage" class="hidden flex flex-col items-center w-full max-w-md px-4">
            <div id="item-card" class="w-64 h-64 bg-slate-800 rounded-3xl border-4 flex flex-col items-center justify-center relative shadow-2xl mb-8 transition-all">
                <div class="absolute inset-0 bg-gradient-to-br from-white/10 to-transparent rounded-2xl pointer-events-none"></div>
                <i id="item-icon" class="text-8xl mb-4 drop-shadow-md transition-transform hover:scale-110"></i>
                <h2 id="item-name" class="text-2xl font-black font-['Black_Ops_One'] uppercase text-center leading-none px-2 text-white drop-shadow-lg">Item Name</h2>
                <span id="item-rarity-badge" class="mt-2 px-3 py-1 rounded-full text-xs font-bold uppercase bg-black/40 tracking-wider">Common</span>
            </div>
            <div class="flex gap-4 w-full">
                <button id="btn-sell" class="flex-1 bg-slate-800 hover:bg-slate-700 border border-slate-600 py-4 rounded-xl flex flex-col items-center gap-1 group transition-all active:scale-95">
                    <span class="text-slate-400 text-xs font-bold uppercase tracking-wider">Sell Now</span>
                    <div class="flex items-center gap-2"><i class="fa-solid fa-coins text-yellow-400 group-hover:rotate-12 transition-transform"></i><span id="sell-price" class="text-2xl font-bold font-mono text-white">10</span></div>
                </button>
                <button id="btn-collect" class="flex-1 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 py-4 rounded-xl flex flex-col items-center justify-center gap-1 shadow-lg shadow-green-900/50 transition-all active:scale-95">
                    <span class="text-green-100 text-xs font-bold uppercase tracking-wider">Keep Item</span>
                    <div class="flex items-center gap-2"><i class="fa-solid fa-backpack text-white"></i><span class="text-xl font-bold text-white uppercase">Collect</span></div>
                </button>
            </div>
        </div>
    </main>

    <div id="inventory-modal" class="fixed inset-0 z-50 bg-black/90 backdrop-blur hidden flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-slate-700 w-full max-w-5xl h-[85vh] rounded-3xl flex flex-col shadow-2xl overflow-hidden">
            <div class="p-6 bg-slate-800/50 border-b border-slate-700 flex justify-between items-center">
                <div><h2 class="text-3xl font-['Black_Ops_One'] uppercase text-white">Storage</h2><p id="inv-count" class="text-slate-400 text-sm">0 Items collected</p></div>
                <button id="close-inv" class="w-10 h-10 rounded-full bg-slate-800 hover:bg-slate-700 flex items-center justify-center"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div id="inventory-grid" class="flex-1 overflow-y-auto p-6 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4 content-start"></div>
        </div>
    </div>

    <div id="codes-modal" class="fixed inset-0 z-50 bg-black/90 backdrop-blur hidden flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-slate-700 w-full max-w-md rounded-3xl flex flex-col shadow-2xl overflow-hidden">
            <div class="p-6 bg-gradient-to-r from-purple-900/50 to-pink-900/50 border-b border-slate-700 flex justify-between items-center">
                <div>
                    <h2 class="text-3xl font-['Black_Ops_One'] uppercase text-white flex items-center gap-2">
                        <i class="fa-solid fa-ticket text-purple-400"></i> Codes
                    </h2>
                    <p class="text-slate-400 text-sm">Enter codes for rewards</p>
                </div>
                <button id="close-codes" class="w-10 h-10 rounded-full bg-slate-800 hover:bg-slate-700 flex items-center justify-center"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-6 flex flex-col gap-4">
                <div class="flex flex-col gap-2">
                    <input 
                        type="text" 
                        id="code-input" 
                        placeholder="Enter code here..." 
                        class="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:border-purple-500 transition-colors font-mono uppercase"
                        maxlength="20"
                    />
                    <button id="redeem-code-btn" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 py-3 rounded-xl font-bold uppercase tracking-wider transition-all active:scale-95 shadow-lg">
                        <i class="fa-solid fa-check mr-2"></i> Redeem Code
                    </button>
                </div>
                <div id="code-message" class="text-center text-sm font-bold hidden"></div>
                <div class="border-t border-slate-700 pt-4">
                    <h3 class="text-xs uppercase tracking-wider text-slate-500 font-bold mb-3">Redeemed Codes</h3>
                    <div id="redeemed-codes-list" class="flex flex-col gap-2 max-h-40 overflow-y-auto">
                        <p class="text-slate-600 text-sm text-center py-4">No codes redeemed yet</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <button id="music-toggle" class="music-btn" title="Toggle Music">
        <i class="fa-solid fa-music text-white text-xl"></i>
    </button>

    <script>
        const BOX_TIERS = [
            { id: 'starter', name: 'Cardboard Box', cost: 0, icon: 'ðŸ“¦', desc: 'Random stuff from who knows where.', rates: { common: 60, rare: 90, epic: 99, legendary: 100, mythic: 100 } },
            { id: 'silver', name: 'Silver Case', cost: 150, icon: 'ðŸ’¼', desc: 'Better odds.', rates: { common: 20, rare: 70, epic: 95, legendary: 99.5, mythic: 100 } },
            { id: 'gold', name: 'Gold Chest', cost: 600, icon: 'ðŸ‘‘', desc: 'Heart? No, chest of gold', rates: { common: 0, rare: 40, epic: 85, legendary: 98, mythic: 100 } },
            { id: 'omega', name: 'Comet Case', cost: 2500, icon: 'ðŸ’«', desc: 'Pure chaos.', rates: { common: 0, rare: 0, epic: 50, legendary: 90, mythic: 100 } },
            { id: 'meteor', name: 'Meteor Case', cost: 3000, icon: 'â˜„ï¸', desc: 'Blessed by the stars.', rates: { common: 0, rare: 0, epic: 0, legendary: 90, mythic: 100 } },
            { id: 'clover', name: 'Clover Case', cost: 6000, icon: 'ðŸ€', desc: 'Mythical luck ðŸ˜‰', rates: { common: 0, rare: 0, epic: 0, legendary: 0, mythic: 100 } }
        ];

        const SELL_VALUES = { common: 10, rare: 40, epic: 250, legendary: 1500, mythic: 8000 };

        const ITEMS_DB = {
            common: [{ name: "Broken Twig", icon: "fa-leaf" }, { name: "Grey Rock", icon: "fa-gem" }, { name: "Old Sock", icon: "fa-socks" }, { name: "Rusty Nail", icon: "fa-hammer" }, { name: "Empty Can", icon: "fa-trash-can" }],
            rare: [{ name: "Steel Dagger", icon: "fa-khanda" }, { name: "Blue Potion", icon: "fa-flask" }, { name: "Silver Ring", icon: "fa-ring" }, { name: "Map Fragment", icon: "fa-map" }],
            epic: [{ name: "Plasma Rifle", icon: "fa-gun" }, { name: "Cyber Visor", icon: "fa-vr-cardboard" }, { name: "Golden Chalice", icon: "fa-wine-glass" }, { name: "Hoverboard", icon: "fa-plane" }],
            legendary: [{ name: "Excalibur", icon: "fa-gavel" }, { name: "Dragon Soul", icon: "fa-fire" }, { name: "Royal Crown", icon: "fa-web-awesome"}, { name: "Shooting Star", icon: "https://imgur.com/a/zOm8Zzv"}, { name: "Time Core", icon: "fa-clock" }],
            mythic: [{ name: "THE GLITCH", icon: "fa-bug" }, { name: "Elizabeth, Destroyer of Worlds", icon: "https://media3.giphy.com/media/v1.Y2lkPTc5MGI3NjExOHBkeWE2OHFxNWFzZHhubTQ0bWI5aXFlYmw2cjNvZjFuaXd0YXhhMiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/K62rSDUnPitOgRp1eJ/giphy.gif"}, { name: "Developer Key", icon: "fa-key" }]
        };

        // Codes System
        const VALID_CODES = {
            'blandnesz': { coins: 1000000, description: 'Secret Code' },
            'welcome': { coins: 500, description: 'Welcome Bonus' },
            'comet2026': { coins: 2026, description: 'New Year Gift' },
            'ripskillful': { coins: 10000, description: 'RIP skillful scone' }
        };

        class CodesManager {
            constructor() {
                this.redeemedCodes = [];
                this.loadRedeemed();
            }

            loadRedeemed() {
                const saved = localStorage.getItem('cometcase_codes');
                if (saved) {
                    this.redeemedCodes = JSON.parse(saved);
                }
            }

            saveRedeemed() {
                localStorage.setItem('cometcase_codes', JSON.stringify(this.redeemedCodes));
            }

            isRedeemed(code) {
                return this.redeemedCodes.includes(code.toLowerCase());
            }

            redeemCode(code) {
                const normalizedCode = code.toLowerCase().trim();
                
                if (!normalizedCode) {
                    return { success: false, message: 'Please enter a code' };
                }

                if (this.isRedeemed(normalizedCode)) {
                    return { success: false, message: 'Code already redeemed!' };
                }

                const codeData = VALID_CODES[normalizedCode];
                if (!codeData) {
                    return { success: false, message: 'Invalid code' };
                }

                this.redeemedCodes.push(normalizedCode);
                this.saveRedeemed();

                return { 
                    success: true, 
                    message: `+${codeData.coins.toLocaleString()} coins!`, 
                    coins: codeData.coins 
                };
            }

            getRedeemedList() {
                return this.redeemedCodes.map(code => ({
                    code: code,
                    data: VALID_CODES[code]
                }));
            }
        }

        // Background Music System
        class BackgroundMusic {
            constructor() {
                this.audioContext = null;
                this.isPlaying = false;
                this.masterGain = null;
                this.oscillators = [];
                this.musicInterval = null;
                
                // Chord progression (I-V-vi-IV in C major)
                this.chords = [
                    [261.63, 329.63, 392.00], // C major
                    [392.00, 493.88, 587.33], // G major
                    [440.00, 523.25, 659.25], // A minor
                    [349.23, 440.00, 523.25]  // F major
                ];
                this.currentChordIndex = 0;
            }

            init() {
                if (!this.audioContext) {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.masterGain = this.audioContext.createGain();
                    this.masterGain.connect(this.audioContext.destination);
                    this.masterGain.gain.value = 0.08; // Low volume for background
                }
            }

            start() {
                this.init();
                if (this.isPlaying) return;
                this.isPlaying = true;
                
                document.getElementById('music-toggle').classList.add('playing');
                
                this.playChord();
                this.musicInterval = setInterval(() => {
                    this.currentChordIndex = (this.currentChordIndex + 1) % this.chords.length;
                    this.playChord();
                }, 2000); // Change chord every 2 seconds
            }

            playChord() {
                const ctx = this.audioContext;
                const chord = this.chords[this.currentChordIndex];
                
                chord.forEach((freq, i) => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    
                    osc.connect(gain);
                    gain.connect(this.masterGain);
                    
                    osc.frequency.setValueAtTime(freq, ctx.currentTime);
                    osc.type = 'sine';
                    
                    // Fade in and out
                    gain.gain.setValueAtTime(0, ctx.currentTime);
                    gain.gain.linearRampToValueAtTime(0.15, ctx.currentTime + 0.3);
                    gain.gain.setValueAtTime(0.15, ctx.currentTime + 1.5);
                    gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 2);
                    
                    osc.start(ctx.currentTime);
                    osc.stop(ctx.currentTime + 2);
                });
            }

            stop() {
                this.isPlaying = false;
                document.getElementById('music-toggle').classList.remove('playing');
                if (this.musicInterval) {
                    clearInterval(this.musicInterval);
                    this.musicInterval = null;
                }
            }

            toggle() {
                if (this.isPlaying) {
                    this.stop();
                } else {
                    this.start();
                }
            }
        }

        // Sound System
        class SoundFX {
            constructor() {
                this.audioContext = null;
            }

            init() {
                if (!this.audioContext) {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
            }

            playTap(intensity = 1) {
                this.init();
                const ctx = this.audioContext;
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                osc.frequency.setValueAtTime(400 + (intensity * 200), ctx.currentTime);
                osc.type = 'square';
                
                gain.gain.setValueAtTime(0.15, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
                
                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime + 0.1);
            }

            playOpen(rarity) {
                this.init();
                const ctx = this.audioContext;
                const rarityPitch = { common: 1, rare: 1.2, epic: 1.5, legendary: 1.8, mythic: 2.2 };
                const multiplier = rarityPitch[rarity] || 1;
                
                // Multiple oscillators for rich sound
                for (let i = 0; i < 3; i++) {
                    setTimeout(() => {
                        const osc = ctx.createOscillator();
                        const gain = ctx.createGain();
                        
                        osc.connect(gain);
                        gain.connect(ctx.destination);
                        
                        osc.frequency.setValueAtTime(300 * multiplier + (i * 100), ctx.currentTime);
                        osc.type = 'sine';
                        
                        gain.gain.setValueAtTime(0.2, ctx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.4);
                        
                        osc.start(ctx.currentTime);
                        osc.stop(ctx.currentTime + 0.4);
                    }, i * 50);
                }
            }

            playCoins(isGain = true) {
                this.init();
                const ctx = this.audioContext;
                
                for (let i = 0; i < 2; i++) {
                    setTimeout(() => {
                        const osc = ctx.createOscillator();
                        const gain = ctx.createGain();
                        
                        osc.connect(gain);
                        gain.connect(ctx.destination);
                        
                        if (isGain) {
                            osc.frequency.setValueAtTime(800 + (i * 200), ctx.currentTime);
                        } else {
                            osc.frequency.setValueAtTime(600 - (i * 150), ctx.currentTime);
                        }
                        osc.type = 'sine';
                        
                        gain.gain.setValueAtTime(0.1, ctx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);
                        
                        osc.start(ctx.currentTime);
                        osc.stop(ctx.currentTime + 0.15);
                    }, i * 40);
                }
            }

            playPurchase() {
                this.init();
                const ctx = this.audioContext;
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                osc.frequency.setValueAtTime(600, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(400, ctx.currentTime + 0.2);
                osc.type = 'triangle';
                
                gain.gain.setValueAtTime(0.15, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                
                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime + 0.2);
            }
        }

        // VFX Manager
        class VFXManager {
            createClickParticles(x, y, color = '#3b82f6') {
                const particleCount = 12;
                for (let i = 0; i < particleCount; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle click-particle';
                    particle.style.left = x + 'px';
                    particle.style.top = y + 'px';
                    particle.style.background = color;
                    
                    const angle = (Math.PI * 2 * i) / particleCount;
                    const distance = 50 + Math.random() * 50;
                    const tx = Math.cos(angle) * distance;
                    const ty = Math.sin(angle) * distance;
                    
                    particle.style.setProperty('--tx', tx + 'px');
                    particle.style.setProperty('--ty', ty + 'px');
                    
                    document.body.appendChild(particle);
                    setTimeout(() => particle.remove(), 800);
                }
            }

            createTapRing(x, y, color = 'rgba(59, 130, 246, 0.8)') {
                const ring = document.createElement('div');
                ring.className = 'tap-ring';
                ring.style.left = x + 'px';
                ring.style.top = y + 'px';
                ring.style.borderColor = color;
                document.body.appendChild(ring);
                setTimeout(() => ring.remove(), 600);
            }

            createCoinBurst(count = 5) {
                const container = document.getElementById('coin-display');
                const rect = container.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;

                for (let i = 0; i < count; i++) {
                    setTimeout(() => {
                        const coin = document.createElement('div');
                        coin.className = 'coin-burst';
                        coin.textContent = 'ðŸ’µ';
                        coin.style.left = centerX + (Math.random() - 0.5) * 100 + 'px';
                        coin.style.top = centerY + 'px';
                        document.body.appendChild(coin);
                        setTimeout(() => coin.remove(), 1000);
                    }, i * 100);
                }
            }

            createSparkles(x, y, count = 20, color = 'white') {
                for (let i = 0; i < count; i++) {
                    const sparkle = document.createElement('div');
                    sparkle.className = 'sparkle';
                    sparkle.style.left = x + 'px';
                    sparkle.style.top = y + 'px';
                    sparkle.style.background = color;
                    
                    const sx = (Math.random() - 0.5) * 200;
                    const sy = (Math.random() - 0.5) * 200;
                    sparkle.style.setProperty('--sx', sx + 'px');
                    sparkle.style.setProperty('--sy', sy + 'px');
                    
                    document.body.appendChild(sparkle);
                    setTimeout(() => sparkle.remove(), 1500);
                }
            }

            createScreenFlash() {
                const flash = document.createElement('div');
                flash.className = 'screen-flash';
                document.body.appendChild(flash);
                setTimeout(() => flash.remove(), 500);
            }

            createTextPopup(text, x, y, color = '#3b82f6') {
                const popup = document.createElement('div');
                popup.className = 'text-popup';
                popup.textContent = text;
                popup.style.left = x + 'px';
                popup.style.top = y + 'px';
                popup.style.color = color;
                document.body.appendChild(popup);
                setTimeout(() => popup.remove(), 1000);
            }

            createOpeningExplosion(rarity) {
                const rarityColors = {
                    common: '#94a3b8',
                    rare: '#3b82f6',
                    epic: '#a855f7',
                    legendary: '#eab308',
                    mythic: '#ef4444'
                };
                const color = rarityColors[rarity] || '#ffffff';
                const center = { x: window.innerWidth / 2, y: window.innerHeight / 2 };

                // Screen flash
                this.createScreenFlash();

                // Sparkles explosion
                this.createSparkles(center.x, center.y, 40, color);

                // Circular particle burst
                this.createClickParticles(center.x, center.y, color);
                setTimeout(() => this.createClickParticles(center.x, center.y, color), 150);
                setTimeout(() => this.createClickParticles(center.x, center.y, color), 300);
            }
        }

        class Game {
            constructor() {
                this.coins = 0;
                this.inventory = [];
                this.activeBoxId = 'starter';
                this.clickStage = 0;
                this.tempItem = null;

                this.loadGame(); // LOAD DATA ON START
                this.bindUI();
                this.renderShop();
                this.updateUI();
            }

            // --- DATA SAVING LOGIC ---
            saveGame() {
                const saveData = {
                    coins: this.coins,
                    inventory: this.inventory,
                    activeBoxId: this.activeBoxId
                };
                localStorage.setItem('cometcase_save', JSON.stringify(saveData));
            }

            loadGame() {
                const saved = localStorage.getItem('cometcase_save');
                if (saved) {
                    const data = JSON.parse(saved);
                    this.coins = data.coins || 0;
                    this.inventory = data.inventory || [];
                    this.activeBoxId = data.activeBoxId || 'starter';
                }
            }

            bindUI() {
                document.getElementById('box-container').addEventListener('click', () => this.handleBoxClick());
                document.getElementById('btn-collect').addEventListener('click', () => this.collectItem());
                document.getElementById('btn-sell').addEventListener('click', () => this.sellCurrentItem());
                document.getElementById('inventory-toggle').addEventListener('click', () => this.toggleInventory(true));
                document.getElementById('close-inv').addEventListener('click', () => this.toggleInventory(false));
                document.getElementById('music-toggle').addEventListener('click', () => bgMusic.toggle());
                document.getElementById('codes-toggle').addEventListener('click', () => this.toggleCodesMenu(true));
                document.getElementById('close-codes').addEventListener('click', () => this.toggleCodesMenu(false));
                document.getElementById('redeem-code-btn').addEventListener('click', () => this.handleCodeRedeem());
                document.getElementById('code-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.handleCodeRedeem();
                });
                
                const toggleShop = () => {
                    const drawer = document.getElementById('shop-drawer');
                    const overlay = document.getElementById('shop-overlay');
                    const isOpen = drawer.classList.contains('drawer-open');
                    drawer.classList.toggle('drawer-open', !isOpen);
                    drawer.classList.toggle('drawer-closed', isOpen);
                    overlay.classList.toggle('hidden', isOpen);
                };

                document.getElementById('shop-toggle').addEventListener('click', toggleShop);
                document.getElementById('shop-overlay').addEventListener('click', toggleShop);
            }

            toggleCodesMenu(show) {
                const modal = document.getElementById('codes-modal');
                if (show) {
                    modal.classList.remove('hidden');
                    this.updateRedeemedCodesList();
                    document.getElementById('code-input').value = '';
                    document.getElementById('code-message').classList.add('hidden');
                } else {
                    modal.classList.add('hidden');
                }
            }

            updateRedeemedCodesList() {
                const list = document.getElementById('redeemed-codes-list');
                const redeemed = codesManager.getRedeemedList();
                
                if (redeemed.length === 0) {
                    list.innerHTML = '<p class="text-slate-600 text-sm text-center py-4">No codes redeemed yet</p>';
                } else {
                    list.innerHTML = redeemed.map(item => `
                        <div class="bg-slate-800/50 px-3 py-2 rounded-lg flex justify-between items-center">
                            <span class="text-slate-300 font-mono text-sm uppercase">${item.code}</span>
                            <span class="text-green-400 text-xs font-bold">+${item.data.coins.toLocaleString()}</span>
                        </div>
                    `).join('');
                }
            }

            handleCodeRedeem() {
                const input = document.getElementById('code-input');
                const code = input.value;
                const message = document.getElementById('code-message');
                const coinDisplay = document.getElementById('coin-display');
                
                const result = codesManager.redeemCode(code);
                
                if (result.success) {
                    this.coins += result.coins;
                    this.saveGame();
                    this.updateUI();
                    
                    message.className = 'text-center text-sm font-bold text-green-400 code-success';
                    message.textContent = result.message;
                    message.classList.remove('hidden');
                    
                    coinDisplay.classList.add('code-success');
                    setTimeout(() => coinDisplay.classList.remove('code-success'), 600);
                    
                    soundFX.playCoins(true);
                    setTimeout(() => soundFX.playCoins(true), 100);
                    setTimeout(() => soundFX.playCoins(true), 200);
                    
                    input.value = '';
                    this.updateRedeemedCodesList();
                    
                    setTimeout(() => message.classList.add('hidden'), 3000);
                } else {
                    message.className = 'text-center text-sm font-bold text-red-400';
                    message.textContent = result.message;
                    message.classList.remove('hidden');
                    
                    setTimeout(() => message.classList.add('hidden'), 3000);
                }
            }

            updateUI() {
                document.getElementById('coin-display').innerText = this.coins.toLocaleString();
                document.getElementById('inv-badge').innerText = this.inventory.length;
                document.getElementById('inv-badge').classList.toggle('hidden', this.inventory.length === 0);
                
                if (this.clickStage === 0) {
                    const box = BOX_TIERS.find(b => b.id === this.activeBoxId);
                    document.getElementById('current-box-name').innerText = box.name;
                    document.getElementById('box-visual').innerText = box.icon;
                    const costDisplay = document.getElementById('box-cost-display');
                    costDisplay.classList.remove('hidden');
                    costDisplay.innerHTML = box.cost === 0 ? `<span class="text-green-400 font-bold uppercase">Free</span>` : `Cost: <span class="text-yellow-400 font-bold">${box.cost}</span>`;
                }
            }

            renderShop() {
                const list = document.getElementById('shop-list');
                list.innerHTML = '';
                BOX_TIERS.forEach(box => {
                    const el = document.createElement('div');
                    el.className = `p-4 rounded-xl border border-slate-700 bg-slate-800/50 hover:bg-slate-700 transition-colors flex items-center justify-between cursor-pointer group`;
                    el.onclick = () => this.selectBox(box.id);
                    const isActive = this.activeBoxId === box.id;
                    if (isActive) el.classList.add('border-cyan-500', 'bg-slate-800');
                    el.innerHTML = `
                        <div class="flex items-center gap-4">
                            <div class="text-4xl group-hover:scale-110 transition-transform">${box.icon}</div>
                            <div><h3 class="font-bold text-white ${isActive ? 'text-cyan-400' : ''}">${box.name}</h3><p class="text-xs text-slate-400">${box.desc}</p></div>
                        </div>
                        <div class="text-right"><div class="font-mono font-bold ${box.cost === 0 ? 'text-green-400' : 'text-yellow-400'}">${box.cost === 0 ? 'FREE' : box.cost}</div></div>
                    `;
                    list.appendChild(el);
                });
            }

            selectBox(id) {
                this.activeBoxId = id;
                this.clickStage = 0;
                this.renderShop();
                this.saveGame(); // SAVE active box
                this.updateUI();
            }

            handleBoxClick() {
                const boxConfig = BOX_TIERS.find(b => b.id === this.activeBoxId);
                const visual = document.getElementById('box-visual');
                const container = document.getElementById('box-container');
                const rect = container.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                
                if (this.clickStage === 0 && this.coins < boxConfig.cost) return;
                
                if (this.clickStage === 0 && boxConfig.cost > 0) {
                    this.coins -= boxConfig.cost;
                    this.updateUI();
                    this.saveGame(); // SAVE coins after purchase
                    soundFX.playPurchase(); // Play purchase sound
                    vfx.createClickParticles(centerX, centerY, '#ef4444');
                }

                this.clickStage++;
                soundFX.playTap(this.clickStage); // Play tap sound with increasing intensity
                
                // VFX for tapping
                const tapColors = ['#3b82f6', '#a855f7', '#ef4444'];
                vfx.createTapRing(centerX, centerY, tapColors[this.clickStage - 1] || '#3b82f6');
                vfx.createClickParticles(centerX, centerY, tapColors[this.clickStage - 1] || '#3b82f6');
                
                if (this.clickStage === 3) {
                    vfx.createTextPopup('OPENING!', centerX, centerY - 100, '#eab308');
                }
                
                visual.classList.remove('shake-1', 'shake-2', 'animate-float');
                void visual.offsetWidth;

                if (this.clickStage === 1) visual.classList.add('shake-1');
                else if (this.clickStage === 2) visual.classList.add('shake-2');
                else if (this.clickStage >= 3) this.openBox(boxConfig);
            }

            openBox(boxConfig) {
                const rand = Math.random() * 100;
                let rarity = 'common';
                if (rand > boxConfig.rates.legendary) rarity = 'mythic';
                else if (rand > boxConfig.rates.epic) rarity = 'legendary';
                else if (rand > boxConfig.rates.rare) rarity = 'epic';
                else if (rand > boxConfig.rates.common) rarity = 'rare';

                const pool = ITEMS_DB[rarity];
                const item = pool[Math.floor(Math.random() * pool.length)];
                this.tempItem = { ...item, rarity, id: Date.now() + Math.random() };

                soundFX.playOpen(rarity); // Play opening sound based on rarity
                
                // VFX explosion on open
                vfx.createOpeningExplosion(rarity);

                document.getElementById('box-stage').classList.add('hidden');
                document.getElementById('reveal-stage').classList.remove('hidden');
                
                const card = document.getElementById('item-card');
                card.className = `w-64 h-64 rounded-3xl border-4 flex flex-col items-center justify-center relative shadow-2xl mb-8 item-reveal-anim border-${rarity} bg-slate-900`;
                
                // Handle icon (Font Awesome or Image URL)
                const iconEl = document.getElementById('item-icon');
                if (item.icon && item.icon.startsWith('http')) {
                    // It's an image URL
                    iconEl.className = '';
                    iconEl.innerHTML = `<img src="${item.icon}" class="w-32 h-32 object-contain mb-4 drop-shadow-md transition-transform hover:scale-110" style="filter: drop-shadow(0 0 20px var(--rarity-${rarity}));" />`;
                } else {
                    // It's a Font Awesome icon
                    iconEl.innerHTML = '';
                    iconEl.className = `fa-solid ${item.icon} text-8xl mb-4 text-${rarity}`;
                }
                
                document.getElementById('item-name').innerText = item.name;
                document.getElementById('item-name').className = `text-2xl font-black font-['Black_Ops_One'] uppercase text-center text-${rarity}`;
                document.getElementById('item-rarity-badge').className = `mt-2 px-3 py-1 rounded-full text-xs font-bold uppercase bg-${rarity} text-slate-900`;
                document.getElementById('item-rarity-badge').innerText = rarity;
                document.getElementById('sell-price').innerText = SELL_VALUES[rarity];

                if (['epic', 'legendary', 'mythic'].includes(rarity)) document.getElementById('sunburst').classList.remove('hidden');
            }

            collectItem() {
                this.inventory.push(this.tempItem);
                this.saveGame(); // SAVE inventory
                this.resetStage();
            }

            sellCurrentItem() {
                this.coins += SELL_VALUES[this.tempItem.rarity];
                soundFX.playCoins(true); // Play coin gain sound
                vfx.createCoinBurst(8); // Coin burst VFX
                vfx.createTextPopup(`+${SELL_VALUES[this.tempItem.rarity]}`, window.innerWidth / 2, window.innerHeight / 2 - 150, '#eab308');
                this.saveGame(); // SAVE coins
                this.resetStage();
            }

            resetStage() {
                this.clickStage = 0;
                document.getElementById('reveal-stage').classList.add('hidden');
                document.getElementById('box-stage').classList.remove('hidden');
                document.getElementById('sunburst').classList.add('hidden');
                document.getElementById('box-visual').classList.add('animate-float');
                this.updateUI();
            }

            toggleInventory(show) {
                const modal = document.getElementById('inventory-modal');
                const grid = document.getElementById('inventory-grid');
                if (show) {
                    modal.classList.remove('hidden');
                    document.getElementById('inv-count').innerText = `${this.inventory.length} items`;
                    grid.innerHTML = '';
                    const rarityOrder = { mythic: 5, legendary: 4, epic: 3, rare: 2, common: 1 };
                    const sorted = [...this.inventory].sort((a,b) => rarityOrder[b.rarity] - rarityOrder[a.rarity]);
                    sorted.forEach(item => {
                        const el = document.createElement('div');
                        el.className = `relative aspect-square bg-slate-800/50 rounded-xl border-2 border-${item.rarity} flex flex-col items-center justify-center p-2 group`;
                        
                        // Handle icon display (Font Awesome or Image URL)
                        let iconHTML = '';
                        if (item.icon && item.icon.startsWith('http')) {
                            iconHTML = `<img src="${item.icon}" class="w-12 h-12 object-contain mb-2" style="filter: drop-shadow(0 0 8px var(--rarity-${item.rarity}));" />`;
                        } else {
                            iconHTML = `<i class="fa-solid ${item.icon} text-3xl mb-2 text-${item.rarity}"></i>`;
                        }
                        
                        el.innerHTML = `${iconHTML}<span class="text-[10px] font-bold text-slate-300 text-center">${item.name}</span><button class="absolute bottom-2 left-2 right-2 bg-slate-700 hover:bg-red-600 text-white text-[10px] py-1 rounded opacity-0 group-hover:opacity-100" onclick="game.sellFromInventory(${item.id})">Sell ${SELL_VALUES[item.rarity]}</button>`;
                        grid.appendChild(el);
                    });
                } else modal.classList.add('hidden');
            }

            sellFromInventory(itemId) {
                const idx = this.inventory.findIndex(i => i.id === itemId);
                if (idx > -1) {
                    const sellValue = SELL_VALUES[this.inventory[idx].rarity];
                    this.coins += sellValue;
                    soundFX.playCoins(true); // Play coin gain sound
                    vfx.createCoinBurst(5); // Coin burst VFX
                    this.inventory.splice(idx, 1);
                    this.saveGame(); // SAVE after inventory sell
                    this.toggleInventory(true); 
                    this.updateUI();
                }
            }
        }

        const bgMusic = new BackgroundMusic();
        const soundFX = new SoundFX();
        const vfx = new VFXManager();
        const codesManager = new CodesManager();
        const game = new Game();
    </script>
</body>
</html>
